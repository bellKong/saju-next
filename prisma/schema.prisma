// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Application Models
model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // OAuth identifiers (cache for convenience)
  kakaoId       String?  @unique
  googleId      String?  @unique

  // Profile info
  birthDate     String?
  gender        String?  // male|female

  // Credit balance (cache)
  creditBalance Int      @default(0)

  accounts       Account[]
  sessions       Session[]
  paymentIntents PaymentIntent[]
  payments       Payment[]
  creditLedgers  CreditLedger[]
  readings       Reading[]
  shares         Share[]
  persons        Person[]
}

model PaymentIntent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider    String   // "toss" | "kakaopay"
  productCode String   // "CREDIT_1" | "CREDIT_5" | "CREDIT_10"
  amount      Int
  currency    String   @default("KRW")

  // Payment provider order/transaction key
  providerOrderId String? @unique
  status      String   @default("CREATED") // CREATED|REQUESTED|EXPIRED

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payments    Payment[]
}

model Payment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider    String   // "toss" | "kakaopay"
  amount      Int
  currency    String   @default("KRW")

  // Payment provider unique key (for idempotency)
  providerPaymentId String @unique

  // Our order key (link to intent)
  paymentIntentId String?
  paymentIntent   PaymentIntent? @relation(fields: [paymentIntentId], references: [id])

  status      String   // CONFIRMED|CANCELED|REFUNDED|FAILED|PENDING
  raw         Json?    // Store verification response for audit/debug

  confirmedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creditLedgers CreditLedger[]
}

model CreditLedger {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // +purchase / -consume
  delta     Int

  // Reason for change
  reason    String   // PURCHASE|CONSUME|ADMIN_ADJUST|REFUND_REVERSAL etc

  // Link to payment/reading for tracking
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  readingId String?
  reading   Reading? @relation(fields: [readingId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Reading {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String   // SAJU|COMPAT|FORTUNE
  input     Json     // User input (birthdate/gender/partner info etc)
  result    Json     // OpenAI result (structured recommended)
  summary   String?  // Summary for list display (optional)
  createdAt DateTime @default(now())

  // Link to person
  personId  String?
  person    Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)

  // Sharing policy
  isShareable Boolean @default(true)

  creditLedgers CreditLedger[]
  share       Share?
}

model Person {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  relationship  String   // 본인|친구|가족|연인|부모|자녀
  birthDate     String
  birthTime     String?  // null = 모름
  calendarType  String   @default("양력") // 양력|음력
  gender        String   // male|female

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  readings      Reading[]
  manseryeok    Manseryeok?

  @@index([userId])
}

model Manseryeok {
  id          String   @id @default(cuid())
  personId    String   @unique
  person      Person   @relation(fields: [personId], references: [id], onDelete: Cascade)

  solarDate   String   // 양력 생년월일
  lunarDate   String   // 음력 생년월일
  sajuYear    Int      // 입춘 기준 사주 연도

  // 연주 (年柱)
  yearGan     String   // 천간 한자 (甲)
  yearJi      String   // 지지 한자 (子)
  yearGanKr   String   // 천간 한글 (갑)
  yearJiKr    String   // 지지 한글 (자)
  yearOhangGan String  // 천간 오행 (木)
  yearOhangJi  String  // 지지 오행 (水)

  // 월주 (月柱)
  monthGan     String
  monthJi      String
  monthGanKr   String
  monthJiKr    String
  monthOhangGan String
  monthOhangJi  String

  // 일주 (日柱)
  dayGan       String
  dayJi        String
  dayGanKr     String
  dayJiKr      String
  dayOhangGan  String
  dayOhangJi   String

  // 시주 (時柱) — 출생시간 모르면 null
  timeGan      String?
  timeJi       String?
  timeGanKr    String?
  timeJiKr     String?
  timeOhangGan String?
  timeOhangJi  String?

  // 오행 집계
  ohangMok     Int     @default(0) // 木
  ohangHwa     Int     @default(0) // 火
  ohangTo      Int     @default(0) // 土
  ohangGeum    Int     @default(0) // 金
  ohangSu      Int     @default(0) // 水

  createdAt    DateTime @default(now())
}

model Share {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  readingId String   @unique
  reading   Reading  @relation(fields: [readingId], references: [id], onDelete: Cascade)

  shareId   String   @unique // Token exposed in URL (e.g., nanoid)
  createdAt DateTime @default(now())
  revokedAt DateTime?
}
